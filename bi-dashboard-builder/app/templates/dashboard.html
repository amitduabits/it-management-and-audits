{% extends "base.html" %}

{% block title %}{{ title }} - BI Dashboard Builder{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1 class="dashboard-title">{{ title }}</h1>
            <p class="dashboard-subtitle">
                {{ config.get('description', '') }}
                <span class="data-badge">{{ summary.rows | default(0) }} records</span>
                <span class="data-badge">{{ summary.columns | default(0) }} columns</span>
            </p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" id="refreshBtn" title="Refresh data">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                <span>Refresh</span>
            </button>
            <button class="btn btn-outline" id="exportBtn" title="Export configuration">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Export</span>
            </button>
            <button class="btn btn-outline" id="fullscreenBtn" title="Toggle fullscreen">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Filters Bar -->
    {% if filters %}
    <div class="filters-bar" id="filtersBar">
        <div class="filters-header">
            <div class="filters-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                <span>Filters</span>
            </div>
            <button class="btn btn-sm btn-ghost" id="clearFiltersBtn">Clear All</button>
        </div>
        <div class="filters-grid">
            {% for col, filter_info in filters.items() %}
            <div class="filter-group">
                <label class="filter-label" for="filter_{{ col }}">{{ filter_info.label }}</label>
                {% if filter_info.type == 'select' %}
                <select class="filter-select" id="filter_{{ col }}" data-column="{{ col }}">
                    <option value="">All</option>
                    {% for val in filter_info.values %}
                    <option value="{{ val }}">{{ val }}</option>
                    {% endfor %}
                </select>
                {% elif filter_info.type == 'date_range' %}
                <div class="date-range-group">
                    <input type="date" class="filter-date" id="filter_{{ col }}_start"
                           data-column="{{ col }}" data-type="start"
                           value="{{ filter_info.min }}" min="{{ filter_info.min }}" max="{{ filter_info.max }}">
                    <span class="date-separator">to</span>
                    <input type="date" class="filter-date" id="filter_{{ col }}_end"
                           data-column="{{ col }}" data-type="end"
                           value="{{ filter_info.max }}" min="{{ filter_info.min }}" max="{{ filter_info.max }}">
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- KPI Cards -->
    {% if kpis %}
    <section class="kpi-section">
        <div class="kpi-grid">
            {% for kpi in kpis %}
            <div class="kpi-card {{ kpi.trend }}" data-kpi-index="{{ loop.index0 }}">
                <div class="kpi-header">
                    <span class="kpi-label">{{ kpi.label }}</span>
                    <div class="kpi-icon-wrapper kpi-icon-{{ kpi.trend }}">
                        {% if kpi.trend == 'up' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        {% elif kpi.trend == 'down' %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                            <polyline points="17 18 23 18 23 12"></polyline>
                        </svg>
                        {% else %}
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                        {% endif %}
                    </div>
                </div>
                <div class="kpi-value">{{ kpi.formatted }}</div>
                <div class="kpi-footer">
                    {% if kpi.change_pct is not none %}
                    <span class="kpi-change {{ 'positive' if kpi.change_pct > 0 else 'negative' if kpi.change_pct < 0 else '' }}">
                        {% if kpi.change_pct > 0 %}+{% endif %}{{ kpi.change_pct }}%
                    </span>
                    <span class="kpi-period">vs. previous period</span>
                    {% else %}
                    <span class="kpi-function">{{ kpi.function | default('') }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Charts Grid -->
    {% if charts %}
    <section class="charts-section">
        <div class="charts-grid">
            {% for chart in charts %}
            <div class="chart-card {% if chart.type in ['heatmap', 'stacked_bar'] %}chart-wide{% endif %}" data-chart-index="{{ chart.index }}">
                <div class="chart-card-header">
                    <h3 class="chart-title">{{ chart.title }}</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="toggleChartFullscreen({{ chart.index }})" title="Expand chart">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <polyline points="9 21 3 21 3 15"></polyline>
                                <line x1="21" y1="3" x2="14" y2="10"></line>
                                <line x1="3" y1="21" x2="10" y2="14"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="chart-body" id="chart-container-{{ chart.index }}">
                    {% if chart.error %}
                    <div class="chart-error">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>{{ chart.error }}</p>
                    </div>
                    {% else %}
                    {{ chart.html | safe }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Data Preview Table -->
    <section class="data-preview-section">
        <div class="section-header">
            <h2 class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"></path>
                </svg>
                Data Preview
            </h2>
            <div class="table-controls">
                <input type="text" class="table-search" id="tableSearch" placeholder="Search records...">
                <select class="table-page-size" id="tablePageSize">
                    <option value="10">10 rows</option>
                    <option value="25" selected>25 rows</option>
                    <option value="50">50 rows</option>
                    <option value="100">100 rows</option>
                </select>
            </div>
        </div>
        <div class="table-wrapper" id="dataTableWrapper">
            <div class="table-loading">
                <div class="spinner"></div>
                <span>Loading data preview...</span>
            </div>
        </div>
        <div class="table-pagination" id="tablePagination"></div>
    </section>

    <!-- Chart Fullscreen Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3 id="modalChartTitle"></h3>
                <button class="chart-modal-close" onclick="closeChartModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="chart-modal-body" id="modalChartBody"></div>
        </div>
    </div>

</div>

<!-- Store session ID for JS -->
<script>
    window.DASHBOARD_SESSION_ID = "{{ session_id }}";
    window.DASHBOARD_CHARTS = {{ charts | tojson }};
</script>
{% endblock %}

{% block scripts %}
<script>
    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
        loadDataPreview();

        // Resize all Plotly charts to fit containers
        setTimeout(function() {
            var charts = document.querySelectorAll('.js-plotly-plot');
            charts.forEach(function(chart) {
                Plotly.Plots.resize(chart);
            });
        }, 300);
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        var charts = document.querySelectorAll('.js-plotly-plot');
        charts.forEach(function(chart) {
            Plotly.Plots.resize(chart);
        });
    });
</script>
{% endblock %}
